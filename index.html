<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Druck Rechner (Offline Version)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; font-family: sans-serif; }
        #viewer-container {
            width: 100%; height: 400px; background: #333; 
            border-radius: 8px; overflow: hidden; position: relative;
        }
        #loading {
            position: absolute; top:0; left:0; width:100%; height:100%; 
            background: rgba(0,0,0,0.8); color: white; display: none; 
            justify-content: center; align-items: center; z-index: 10;
        }
    </style>
</head>
<body>

<div class="container py-4">
    <h2 class="text-center mb-4">3D-Druckzeitrechner</h2>
    
    <div class="row">
        <div class="col-md-7 mb-3">
            <div id="viewer-container">
                <div id="loading">Berechne...</div>
            </div>
            <input type="file" id="stlInput" accept=".stl" class="form-control mt-3">
        </div>

        <div class="col-md-5">
            <div class="card p-3">
                <h5 class="mb-3">Einstellungen</h5>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">Drucker Profil</label>
                    <select id="printerSelect" class="form-select" onchange="updatePreset()">
                        <option value="neptune3">Elegoo Neptune 3 Pro (60mm/s)</option>
                        <option value="neptune4">Elegoo Neptune 4 (250mm/s)</option>
                        <option value="ender3">Ender 3 V2 (50mm/s)</option>
                        <option value="bambu">Bambu Lab X1C (300mm/s)</option>
                    </select>
                </div>

                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <label class="small">Speed (mm/s)</label>
                        <input type="number" id="speed" class="form-control" value="60">
                    </div>
                    <div class="col-6">
                        <label class="small">Layer (mm)</label>
                        <input type="number" id="layer" class="form-control" value="0.2">
                    </div>
                    <div class="col-6">
                        <label class="small">Düse (mm)</label>
                        <input type="number" id="nozzle" class="form-control" value="0.4">
                    </div>
                    <div class="col-6">
                        <label class="small">Infill (%)</label>
                        <input type="number" id="infill" class="form-control" value="20">
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Material</label>
                    <select id="material" class="form-select">
                        <option value="1.24">PLA (1.24 g/cm³)</option>
                        <option value="1.27">PETG (1.27 g/cm³)</option>
                        <option value="1.04">ABS (1.04 g/cm³)</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="small">Preis (€/kg)</label>
                    <input type="number" id="price" class="form-control" value="20.00">
                </div>

                <button onclick="calculate()" class="btn btn-primary w-100">Berechnen</button>
            </div>
        </div>
    </div>

    <div class="row mt-4" id="results" style="display:none;">
        <div class="col-12">
            <div class="card bg-dark text-white p-4">
                <div class="row text-center">
                    <div class="col-md-4">
                        <div class="text-white-50">ZEIT (CA.)</div>
                        <div class="display-6 fw-bold" id="resTime">--</div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-white-50">GEWICHT</div>
                        <div class="display-6 fw-bold" id="resWeight">--</div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-white-50">KOSTEN</div>
                        <div class="display-6 fw-bold text-success" id="resCost">--</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/three@0.128.0/build/three.min.js"></script>
<script src="https://unpkg.com/three@0.128.0/examples/js/loaders/STLLoader.js"></script>
<script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

<script>
    // --- Globale Variablen ---
    let scene, camera, renderer, mesh, volumeCm3 = 0;
    
    // --- 1. Setup der 3D Szene ---
    function init() {
        const container = document.getElementById('viewer-container');
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x333333);
        
        // Licht
        scene.add(new THREE.AmbientLight(0xffffff, 0.6));
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(100, 100, 100);
        scene.add(dirLight);

        // Kamera
        camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
        camera.position.set(0, 100, 200);

        // Renderer
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        container.appendChild(renderer.domElement);

        // Controls
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        
        animate();
    }

    function animate() {
        requestAnimationFrame(animate);
        renderer.render(scene, camera);
    }

    // --- 2. Datei Laden ---
    document.getElementById('stlInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if(!file) return;

        document.getElementById('loading').style.display = 'flex';
        
        const loader = new THREE.STLLoader();
        const reader = new FileReader();

        reader.onload = function(event) {
            const geometry = loader.parse(event.target.result);
            
            if(mesh) scene.remove(mesh);
            const material = new THREE.MeshPhongMaterial({ color: 0x00d2ff, specular: 0x111111, shininess: 200 });
            mesh = new THREE.Mesh(geometry, material);

            // Zentrieren und Rotieren
            geometry.computeBoundingBox();
            const center = new THREE.Vector3();
            geometry.boundingBox.getCenter(center);
            mesh.position.sub(center);
            mesh.rotation.x = -Math.PI / 2;

            // Kamera anpassen
            const box = geometry.boundingBox;
            const maxDim = Math.max(box.max.x-box.min.x, box.max.y-box.min.y, box.max.z-box.min.z);
            camera.position.z = maxDim * 2.5;

            scene.add(mesh);

            // Volumen berechnen
            volumeCm3 = getVolume(geometry) / 1000; // mm3 zu cm3
            
            document.getElementById('loading').style.display = 'none';
            calculate();
        };

        reader.readAsArrayBuffer(file);
    });

    // Volumen Formel
    function getVolume(geometry) {
        let position = geometry.attributes.position;
        let faces = position.count / 3;
        let sum = 0;
        let p1 = new THREE.Vector3(), p2 = new THREE.Vector3(), p3 = new THREE.Vector3();
        for (let i = 0; i < faces; i++) {
            p1.fromBufferAttribute(position, i * 3 + 0);
            p2.fromBufferAttribute(position, i * 3 + 1);
            p3.fromBufferAttribute(position, i * 3 + 2);
            sum += p1.dot(p2.cross(p3)) / 6.0;
        }
        return Math.abs(sum);
    }

    // --- 3. Berechnung ---
    window.calculate = function() {
        if(volumeCm3 <= 0) return;

        const speed = parseFloat(document.getElementById('speed').value);
        const layer = parseFloat(document.getElementById('layer').value);
        const nozzle = parseFloat(document.getElementById('nozzle').value);
        const infill = parseFloat(document.getElementById('infill').value) / 100;
        const density = parseFloat(document.getElementById('material').value);
        const priceKg = parseFloat(document.getElementById('price').value);

        // 1. Effektives Volumen (Schale + Infill)
        // Annahme: 30% des Modells sind Wände (100% gefüllt), 70% sind Infill-Bereich
        const shellRatio = 0.30; 
        const effectiveVolume = volumeCm3 * (shellRatio + ((1 - shellRatio) * infill));

        // 2. Gewicht & Kosten
        const weight = effectiveVolume * density;
        const cost = (weight / 1000) * priceKg;

        // 3. Zeit Berechnung (Pfadlänge)
        const volMm3 = effectiveVolume * 1000;
        // Länge der "Wurst" = Volumen / Querschnitt
        const pathLengthMm = volMm3 / (layer * nozzle);
        
        // Druckzeit = Weg / Geschwindigkeit
        let timeSeconds = pathLengthMm / speed;
        
        // Overhead (Retracts, Travel, Accel) -> +40%
        timeSeconds = timeSeconds * 1.4;
        // Startzeit (Aufheizen) -> +5 min
        timeSeconds += 300;

        const h = Math.floor(timeSeconds / 3600);
        const m = Math.floor((timeSeconds % 3600) / 60);

        // Anzeigen
        document.getElementById('resTime').innerText = h + "h " + m + "m";
        document.getElementById('resWeight').innerText = weight.toFixed(1) + " g";
        document.getElementById('resCost').innerText = cost.toFixed(2) + " €";
        document.getElementById('results').style.display = 'block';
    }

    // --- Helper für Presets ---
    window.updatePreset = function() {
        const val = document.getElementById('printerSelect').value;
        const s = document.getElementById('speed');
        if(val === 'neptune3') s.value = 60;
        if(val === 'neptune4') s.value = 250;
        if(val === 'ender3') s.value = 50;
        if(val === 'bambu') s.value = 300;
        calculate();
    }

    // Start
    init();
</script>

</body>
</html>
